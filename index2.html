<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://kit.fontawesome.com/8f8b34b02d.js" crossorigin="anonymous"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Acme&family=Bree+Serif&family=Permanent+Marker&family=Satisfy&display=Roboto+Condensed:ital@1&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vue-loading-overlay@3.3.2/dist/vue-loading.css">
    <link rel="stylesheet" href="index.css">

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-loading-overlay@3.3.2/dist/vue-loading.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vee-validate/3.3.0/vee-validate.full.min.js"></script>
    <title>Document</title>
</head>
<body>
    <div id="app">
        <div class="navbar">
            <nav>
              <a href="#">MakeUp Beauty</a>
              <form>
                <input type="search" placeholder="Search" aria-label="Search" id="searchbar">
                <button type="button" id="searchbtn"><i class="fa fa-search"></i></button>
                <button type="button" id="searchbtn"><i class="far fa-user"></i></button>
                <button type="button" id="searchbtn"><i class="fas fa-shopping-cart"></i></button>
              </form>
            </nav>
          </div>
          <div class="wrapper">
            <img src="img/banner.jpg" alt="" style="width: 100% ">
          </div>
          <!-- <button type="button" class="btn" @click="getcarItem()">Add To Cart</button> -->
          
          <div  class="itemlist">
            <div v-for="item in products" :key="item.id" class="item">
              <div class="itemimg"> 
                <img :src=`${item.imageUrl[0]}` alt="">
              </div>
              <span class="tag">{{item.category}}</span>
              <h5 class="item-tilte"><a href="#">{{item.title}}</a></h5>
              <p class="item-content">{{item.content}}</p>
              <div class="price">
                <p>
                  <span class="origin_price">NT${{item.origin_price}}</span> 
                  <span>NT${{item.price}}</span>
                </p>
              </div>
              <div class="btn_container">
                <button type="button" class="btn" @click="addToCart(item)">Add To Cart</button>
                <button type="button" class="btn">Quick View</button>
              </div>
            </div>
          </div>
          <div class="my-5 row justify-content-center">
            <div class="col-md-6">
              <div class="text-right mb-3">
                <button type="button" class="btn btn-outline-danger btn-sm" @click="deleteAll()">
                  <i class="far fa-trash-alt"> 刪除所有品項</i>
                </button>
              </div>
              <table class="table">
                <thead>
                  <th>刪除</th>
                  <th>品名</th>
                  <th width="150px">
                    數量
                  </th>
                  <th>單位</th>
                  <th>單價</th>
                </thead>
                <tbody v-if="cart.length">
                  <tr v-for="item in cart" :key="item.id">
                    <td class="align-middle">
                      <button type="button" class="btn btn-outline-danger btn-sm" @click="removeItem(item.product.id)">
                        <i class="far fa-trash-alt"></i>
                      </button>
                    </td>
                    <td class="align-middle">
                      {{ item.product.title }}
                    </td>
                    <td class="align-middle">
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <button class="btn btn-outline-primary"
                            type="button"
                            @click="quantityUpdata(item.product.id, item.quantity + 1)">
                            +
                          </button>
                        </div>
                        <input id="inlineFormInputGroupUsername" type="text" class="form-control text-center"
                          :value="item.quantity">
                        <div class="input-group-append">
                          <button class="btn btn-outline-primary"
                            type="button"
                            @click="quantityUpdata(item.product.id, item.quantity - 1)"
                            :disabled="item.quantity === 1">
                            -
                          </button>
                        </div>
                      </div>
                    </td>
                    <td class="align-middle">
                      {{ item.product.unit }}
                    </td>
                    <td class="align-middle text-right">
                      {{ item.product.price }}
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="text-right">
                      總計
                    </td>
                    <td class="text-right">
                      {{ total_cost }}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          <div  class="my-5 row justify-content-center">
            <validation-observer v-slot="{ invalid }" class="col-md-6">
              <form @submit.prevent="sendorder">
                <div class="form-group">
                  <validation-provider v-slot="{ errors, classes }" rules="required">
                    <label for="username">收件人姓名</label>
                    <input id="username" v-model="form.username" type="text" class="form-control" :class="classes">
                    <span v-if="errors[0]" class="text-danger">{{ errors[0] }}</span>
                  </validation-provider>
                </div>
                <div class="form-group">
                  <validation-provider v-slot="{ errors, classes }" rules="required|email">
                    <label for="email">Email</label>
                    <input id="email" v-model="form.email" type="email" class="form-control" :class="classes">
                    <span v-if="errors[0]" class="text-danger">{{ errors[0] }}</span>
                  </validation-provider>
                </div>
                <div class="form-group">
                  <validation-provider  v-slot="{ errors, classes }" rules="required|min:10">
                    <label for="tel">收件人手機號碼</label>
                    <input id="tel" v-model="form.phone" type="tel" class="form-control" :class="classes">
                    <span v-if="errors[0]" class="text-danger">{{ errors[0] }}</span>
                  </validation-provider>
                </div>
                <div class="form-group">
                  <validation-provider v-slot="{ errors, classes }" rules="required">
                    <label for="address">地址</label>
                    <input id="address" v-model="form.address" type="text" class="form-control" :class="classes">
                    <span v-if="errors[0]" class="text-danger">{{ errors[0] }}</span>
                  </validation-provider>
                </div>
                <div class="form-group">
                  <label for="payment">購買方式</label>
                  <select id="payment" v-model="form.payment" class="form-control" required>
                    <option value="" disabled>
                      請選擇付款方式
                    </option>
                    <option value="WebATM">
                      WebATM
                    </option>
                    <option value="ATM">
                      ATM
                    </option>
                    <option value="CVS">
                      CVS
                    </option>
                    <option value="Barcode">
                      Barcode
                    </option>
                    <option value="Credit">
                      Credit
                    </option>
                    <option value="ApplePay">
                      ApplePay
                    </option>
                    <option value="GooglePay">
                      GooglePay
                    </option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="message">留言</label>
                  <textarea id="message" v-model="form.message" class="form-control" cols="30" rows="3">
                </textarea>
                </div>
                <div class="text-right">
                  <button type="submit" class="btn btn-primary" :disabled="invalid">
                    送出表單
                  </button>
                </div>
              </form>
            </validation-observer>
          </div>
    </div>
  <script>

  Vue.component('loading', VueLoading);
  Vue.component('ValidationProvider', VeeValidate.ValidationProvider);
  Vue.component('ValidationObserver', VeeValidate.ValidationObserver);
  VeeValidate.configure({
    classes: {
      valid: 'is-valid',
      invalid: 'is-invalid',
    }
  });

  new Vue({
    el:'#app',
    data() {
        return {
           products: [],
           api: {
               uuid: '8e167757-8b00-4955-b28e-9494996b792d',
               apiPath: 'https://course-ec-api.hexschool.io',
           },
            cart:{},
            total_cost: 0,
          form: {
            username: '',
            email: '',
            phone: '',
            address: '',
            payment: '',
            message: '',
          },
        }
    },
    methods: {
        getProducts(){
            const url = `${this.api.apiPath}/api/${this.api.uuid}/ec/products`;
            axios.get(url).then(res => {
               //  console.log(res.data.data);
               this.products = res.data.data;
            }).catch(err =>{
                console.log(err);
            })
        },
        addToCart(item, quantity=1){
         const url = `${this.api.apiPath}/api/${this.api.uuid}/ec/shopping`;
         const cart = {
           product: item.id,
           quantity,
         };    
        //  console.log("item:",cart);
         axios.post(url, cart).then(res =>{
           this.getcarItem();
          //  console.log(res);
         }).catch(err =>{
           console.log(err.response.data.errors);
         })
        },
        getcarItem(){
          // console.log("click");
         const url = `${this.api.apiPath}/api/${this.api.uuid}/ec/shopping`;
         axios.get(url).then(res =>{
           this.cart = res.data.data;
          //  this.total_cost +=this.cart.product.price;
           this.cart.forEach((item) => {
             this.total_cost += item.product.price;
           });

           console.log("bag",this.cart);
           // console.log(this.cart.total_cost);
         }).catch(err => {
           console.log(err);
         })
       },
        removeItem(id) {
          // console.log("click");
        this.isLoading = true;
        const url = `${this.api.apiPath}/api/${this.api.uuid}/ec/shopping/${id}`;
        axios.delete(url).then(res => {
          this.isLoading = false;
          this.getcarItem();
          // this.total_cost -= res.data.data.product.price
        });
      },
      quantityUpdata(id, num) {
          // console.log("click");
        if(num <= 0) return;
        this.isLoading = true;
        const url = `${this.api.apiPath}/api/${this.api.uuid}/ec/shopping`;
        const data = {
          product: id,
          quantity: num,
        };
        axios.patch(url, data).then(res => {
          this.isLoading = false;
          this.getcarItem();
        });
      },
      deleteAll(){
          // console.log("click");
        this.isLoading = true;
        const url = `${this.api.apiPath}/api/${this.api.uuid}/ec/shopping/all/product`;

        axios.delete(url)
          .then(res => {
            this.isLoading = false;
            this.getcarItem();
          });
          this.total_cost=0;
      },
      sendorder(){
          alert("訂單完成");
        }
      }, 
    created() {
       this.getProducts();
       this.getcarItem();
   },
 })
  </script>
</body>
</html>